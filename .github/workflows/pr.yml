on: pull_request
name: Review

jobs:

  update-site:
    name: Check that site can be updated
    runs-on: ubuntu-latest
    steps:

      # Install site from our base ref
      - uses: actions/checkout@v4
        with:
          # https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/accessing-contextual-information-about-workflow-runs#github-context
          ref: ${{ github.base_ref }}

      - run: |
          git log
          git branch

      - name: setup-docker-and-composer
        run: |
          docker network create frontend
          docker compose pull
          docker compose up --detach

          # Important: Use --no-interaction to make https://getcomposer.org/doc/06-config.md#discard-changes have effect.
          docker compose exec --user root phpfpm composer install --no-interaction

      - name: Install site
        run: |
          # Install the site from config
          docker compose exec --user root phpfpm vendor/bin/drush site:install --existing-config --yes

      - name: Clean up root stuff
        run: |
          sudo chown -R $USER:$USER vendor/ web/ || true
          sudo chmod -R a+w web/sites/default || true
          echo "--------------------------------------------------------------------------------"
          find web/sites/default/files/translations -ls

          curl --head https://ftp.drupal.org/files/translations/all/field_group/field_group-8.x-3.6.da.po

      # Install site with our current ref
      - uses: actions/checkout@v4
        with:
          # https://github.com/actions/checkout?tab=readme-ov-file#usage
          clean: false

      - name: setup-docker-and-composer
        run: |
          docker compose pull
          docker compose up --detach

          # Important: Use --no-interaction to make https://getcomposer.org/doc/06-config.md#discard-changes have effect.
          docker compose exec --user root phpfpm composer install --no-interaction

      # # https://github.com/mxschmitt/action-tmate
      # - name: Setup tmate session
      #   uses: mxschmitt/action-tmate@v3
      #   with:
      #     limit-access-to-actor: false

      - name: Update site
        run: |
          docker compose exec --user root phpfpm vendor/bin/drush deploy --yes -vvv
