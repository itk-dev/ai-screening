# This is not a standalone Taskfile; it must be included in a main Taskfile which must also define three vars, e.g
#
#   includes:
#     translation:
#       taskfile: ./task/Taskfile.translation.yml
#       vars:
#         TRANSLATION_MODULES:
#           - my_custom_module
#           - another_module
#
#         TRANSLATION_THEMES:
#           - my_custo_them
#           - itkdev_project_theme
#
#         TRANSLATION_LANGUAGES:
#           - da
#
# See https://taskfile.dev/usage/#including-other-taskfiles and https://taskfile.dev/usage/#vars-of-included-taskfiles for details on Taskfile includes.
#
# Furthermore, this Taskfile assumes that the parent Taskfile (i.e. the only including this)
#
# 1. defines a `compose` task to run docker compose and that a `phpfpm` service exists (used to run `sed`)
# 2. defines a `drush` task for running Drush

version: '3'

tasks:
  site-translations:export:
    desc: 'Export site translations for all languages ({{.TRANSLATION_LANGUAGES | join ", "}})'
    cmds:
      - for:
          matrix:
            LANGUAGE:
              ref: .TRANSLATION_LANGUAGES
        cmd: |
          task drush -- locale:export {{.ITEM.LANGUAGE}} --types=customized > translations/site-translations.{{.ITEM.LANGUAGE}}.po

          # Fix plurals spec in Danish PO file
          # https://drupalsun.com/eelke/2020/08/17/tale-mistranslated-plurals
          # https://www.drupal.org/project/drupal/issues/3496223
          if [ "{{.ITEM.LANGUAGE}}" == "da" ]; then
            task compose -- exec phpfpm sed -i "s/Plural-Forms: nplurals=2; plural=(n > 1);/Plural-Forms: nplurals=2; plural=(n != 1);/" translations/site-translations.{{.ITEM.LANGUAGE}}.po
          fi
    requires:
      vars:
        - TRANSLATION_LANGUAGES
    silent: true

  site-translations:import:
    prompt: "Really import site translations?"
    desc: 'Import site translations for all languages ({{.TRANSLATION_LANGUAGES | join ", "}})'
    cmds:
      - for:
          matrix:
            LANGUAGE:
              ref: .TRANSLATION_LANGUAGES
        cmd: task drush -- locale:import --type=not-customized --override=not-customized {{.ITEM.LANGUAGE}} ../translations/site-translations.{{.ITEM.LANGUAGE}}.po
      - task '{{.TASK | replace ":site-translations:import" ":test-pluralization" }}'
    requires:
      vars:
        - TRANSLATION_LANGUAGES
    silent: true

  translations:diff:
    desc: 'git diff all translation files ignoring some date metadata changes'
    cmds:
      # Ignore some PO metadata when git diff'ing, e.g.
      #
      # "POT-Creation-Date: 2025-03-12 18:18+0100\n"
      # "PO-Revision-Date: 2025-03-12 18:18+0100\n"
      - git diff --exit-code --ignore-blank-lines --ignore-matching-lines='^"PO.*-Date' '*.po'

  translations:checkout:
    desc: 'git checkout all translation file changes if only date metadata is changed'
    cmds:
      - git checkout '*.po'
    # https://taskfile.dev/reference/schema#precondition
    preconditions:
      - sh: task {{.TASK | replace ":checkout" ":diff" }}
        msg: |
          Translations seem to have changed.

          Run

              task {{.TASK | replace ":checkout" ":diff" }}

          to check.

  module-translations:export:
    desc: 'Export translations for all modules ({{.TRANSLATION_MODULES | join ", "}}) in all languages ({{.TRANSLATION_LANGUAGES | join ", "}})'
    cmds:
      # https://github.com/go-task/task/discussions/1543
      - for:
          matrix:
            MODULE:
              ref: .TRANSLATION_MODULES
            LANGUAGE:
              ref: .TRANSLATION_LANGUAGES
        cmd: |
          export MODULE_PATH=$(task drush -- php:eval 'echo Drupal::service("extension.list.module")->getPath("{{.ITEM.MODULE}}")')
          if [ -n "$MODULE_PATH" ]; then
            task drush -- potx single --folder=${MODULE_PATH}/ --language {{.ITEM.LANGUAGE}} --translations
            mkdir -p web/${MODULE_PATH}/translations
            mv web/general.pot web/${MODULE_PATH}/translations/{{.ITEM.MODULE}}.{{.ITEM.LANGUAGE}}.po

            # Fix plurals spec in Danish PO file
            # https://drupalsun.com/eelke/2020/08/17/tale-mistranslated-plurals
            # https://www.drupal.org/project/drupal/issues/3496223
            if [ "{{.ITEM.LANGUAGE}}" == "da" ]; then
              task compose -- exec phpfpm sed -i "s/Plural-Forms: nplurals=2; plural=(n > 1);/Plural-Forms: nplurals=2; plural=(n != 1);/" web/${MODULE_PATH}/translations/{{.ITEM.MODULE}}.{{.ITEM.LANGUAGE}}.po
            fi
          fi
    requires:
      vars:
        - TRANSLATION_MODULES
        - TRANSLATION_LANGUAGES
    silent: true

  # @todo Can we use `drush locale:check` and/or `drush locale:update` to update
  # module translations without overriding existing translations?
  # @todo Do we want to override (existing) translations?
  module-translations:import:
    prompt: "Really import module translations?"
    desc: 'Import translations for all modules ({{.TRANSLATION_MODULES | join ", "}}) in all languages ({{.TRANSLATION_LANGUAGES | join ", "}})'
    cmds:
      - for:
          matrix:
            MODULE:
              ref: .TRANSLATION_MODULES
        cmd: |
          export MODULE_PATH=$(task drush -- php:eval 'echo Drupal::service("extension.list.module")->getPath("{{.ITEM.MODULE}}")')
          if [ -n "$MODULE_PATH" ]; then
            task drush -- locale:import-all --override=none ${MODULE_PATH}/translations/
          fi
      - task '{{.TASK | replace ":site-translations:import" ":test-pluralization" }}'
    requires:
      vars:
        - TRANSLATION_MODULES
    silent: true

  theme-translations:export:
    desc: 'Export translations for all themes ({{.TRANSLATION_THEMES | join ", "}}) in all languages ({{.TRANSLATION_LANGUAGES | join ", "}})'
    cmds:
      # https://github.com/go-task/task/discussions/1543
      - for:
          matrix:
            THEME:
              ref: .TRANSLATION_THEMES
            LANGUAGE:
              ref: .TRANSLATION_LANGUAGES
        # `drush potx` always writes to web/general.pot, so we move this file
        # into the desired destination in the `translations` folder inside the
        # module folder.
        cmd: |
          export THEME_PATH=$(task drush -- php:eval 'echo Drupal::service("extension.list.theme")->getPath("{{.ITEM.THEME}}")')
          if [ -n "$THEME_PATH" ]; then
            task drush -- potx single --folder=${THEME_PATH}/ --language {{.ITEM.LANGUAGE}} --translations
            mkdir -p web/${THEME_PATH}/translations
            mv web/general.pot web/${THEME_PATH}/translations/{{.ITEM.THEME}}.{{.ITEM.LANGUAGE}}.po

            # Fix plurals spec in Danish PO file
            # https://drupalsun.com/eelke/2020/08/17/tale-mistranslated-plurals
            # https://www.drupal.org/project/drupal/issues/3496223
            if [ "{{.ITEM.LANGUAGE}}" == "da" ]; then
              task compose -- exec phpfpm sed -i "s/Plural-Forms: nplurals=2; plural=(n > 1);/Plural-Forms: nplurals=2; plural=(n != 1);/" web/${THEME_PATH}/translations/{{.ITEM.THEME}}.{{.ITEM.LANGUAGE}}.po
            fi
          fi
    requires:
      vars:
        - TRANSLATION_THEMES
        - TRANSLATION_LANGUAGES
    silent: true

  theme-translations:import:
    prompt: "Really import theme translations?"
    desc: 'Import translations for all themes ({{.TRANSLATION_THEMES | join ", "}}) in all languages ({{.TRANSLATION_LANGUAGES | join ", "}})'
    cmds:
      - for:
          matrix:
            THEME:
              ref: .TRANSLATION_THEMES
        cmd: |
          export THEME_PATH=$(task drush -- php:eval 'echo Drupal::service("extension.list.theme")->getPath("{{.ITEM.THEME}}")')
          if [ -n "$THEME_PATH" ]; then
            task drush -- locale:import-all --override=none ${THEME_PATH}/translations/
          fi
      - task '{{.TASK | replace ":site-translations:import" ":test-pluralization" }}'
    requires:
      vars:
        - TRANSLATION_THEMES
    silent: true

  config-translations:export:
    desc: 'Export config translation for all languages ({{.TRANSLATION_LANGUAGES | join ", "}})'
    cmds:
      - for:
          matrix:
            LANGUAGE:
              ref: .TRANSLATION_LANGUAGES
        cmd: task drush -- config_translation_po:export {{.ITEM.LANGUAGE}} --clear-same-as-source > config/translations.{{.ITEM.LANGUAGE}}.po
      # Fix plurals spec in Danish PO file
      # https://drupalsun.com/eelke/2020/08/17/tale-mistranslated-plurals
      # https://www.drupal.org/project/drupal/issues/3496223
      - 'task compose -- exec phpfpm sed -i "s/Plural-Forms: nplurals=2; plural=(n > 1);/Plural-Forms: nplurals=2; plural=(n != 1);/" config/translations.da.po'
    requires:
      vars:
        - TRANSLATION_LANGUAGES
    silent: true

  config-translations:import:
    prompt: "Really import config translations?"
    desc: 'Import config translation for all languages ({{.TRANSLATION_LANGUAGES | join ", "}})'
    cmds:
      - for:
          matrix:
            LANGUAGE:
              ref: .TRANSLATION_LANGUAGES
        cmd: task drush -- config_translation_po:import --type=not-customized --override=not-customized da ../config/translations.{{.ITEM.LANGUAGE}}.po
      - task '{{.TASK | replace ":site-translations:import" ":test-pluralization" }}'
    requires:
      vars:
        - TRANSLATION_LANGUAGES
    silent: true

  test-pluralization:
    desc: "Report and test some pluralizations to make sure that they are correct"
    cmds:
      - defer: rm {{.SCRIPT_NAME}}
      - echo "{{.PHP_SCRIPT}}" > {{.SCRIPT_NAME}}
      - task drush -- php:script {{.SCRIPT_NAME}} -- en {{.TRANSLATION_LANGUAGES | join " "}}
    vars:
      SCRIPT_NAME: tmp.php
      PHP_SCRIPT: |
        <?php

        var_export(['locale.translation.formulae' => \Drupal::state()->get('locale.translation.formulae', [])]);

        \$stuff = [];
        foreach (\$extra as \$langcode) {
          \$stuff[\$langcode] = array_map(static fn (\$count) => (new \Drupal\Core\StringTranslation\PluralTranslatableMarkup(\$count, '1 item', '@count items', options: ['langcode' => '{{.ITEM}}']))->render(), range(0, 9));
        }
        var_export(\$stuff);

        // Check Danish translation
        foreach ([
          [0, '0 items'],
          [1, '1 item'],
          [2, '2 items'],
        ] as [\$count, \$expected]) {
          \$actual = (new \Drupal\Core\StringTranslation\PluralTranslatableMarkup(\$count, '1 item', '@count items', options: ['langcode' => 'da']))->render();
          if (\$actual !== \$expected) {
            throw new \RuntimeException(sprintf('count: %d; expected: %s; actual: %s', \$count, var_export(\$expected, true), var_export(\$actual, true)));
          }
        }
    silent: true

  export:
    desc: Run all translation export tasks
    cmds:
      - task {{.TASK | replace ":export" ":config-translations:export"}}
      - task {{.TASK | replace ":export" ":module-translations:export"}}
      - task {{.TASK | replace ":export" ":site-translations:export"}}
      - task {{.TASK | replace ":export" ":theme-translations:export"}}
    silent: true

  import:
    desc: Run all translation import tasks
    cmds:
      - task {{.TASK | replace ":import" ":config-translations:import"}}
      - task {{.TASK | replace ":import" ":module-translations:import"}}
      - task {{.TASK | replace ":import" ":site-translations:import"}}
      - task {{.TASK | replace ":import" ":theme-translations:import"}}
    silent: true
